#!/usr/bin/env ruby
# coding: utf-8

require 'highline/import'
require 'trollop'
require 'yaml'

# load library
file = File.symlink?(__FILE__) ? File.readlink(__FILE__) : __FILE__
lib = File.join File.dirname(file), "/../lib/beeminder"

if File.exists? lib
  # using local version
  require lib
else
  require 'beeminder'
end

usage = "usage: beemind goal value [comment]"
opts = Trollop::options do
  banner usage

  opt :config, "Path to config.", :type => :string, :default => "~/.beeminderrc"
  opt :list,   "List all available goals."
end

Trollop::die usage if not (2..3).include?(ARGV.size) and not opts[:list]
goal, value, comment = ARGV unless opts[:list]

opts[:config] = File.expand_path opts[:config]

if not File.exists? opts[:config]
  # create config
  auth = {
    "account" => ask("Beeminder account:"),
    "token"   => ask("Auth token:")
  }
  File.open(opts[:config], "w+") {|f| YAML.dump yaml, f}
  File.chmod 0600, opts[:config]
  puts "Written config to '#{opts[:config]}.'"
end

# load config
auth = YAML.load File.open(opts[:config])

# login
bee = Beeminder::User.new auth["account"], auth["token"]

if opts[:list]
  # list all available goals
  puts "available goals:"
  goals = bee.goals.sort_by{|g| g.slug}.each do |goal|
    puts "  #{goal.slug} (#{goal.title})"
  end
else
  bee.send goal, value, comment || ""
end
